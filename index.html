<script>
document.addEventListener("DOMContentLoaded", async () => {
    const barcodeInput = document.getElementById("barcode");
    const scanBtn = document.getElementById("scanBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadInput = document.getElementById("uploadInput");

    // --- เปิดกล้องและอ่านบาร์โค้ด ---
    scanBtn.addEventListener("click", async () => {
        if (!("BarcodeDetector" in window)) {
            alert("เครื่องนี้ไม่รองรับ Barcode Detector API");
            return;
        }

        try {
            const detector = new BarcodeDetector({ formats: ["ean_13", "code_128", "upc_a"] });

            // เปิดกล้อง
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();

            // overlay UI
            document.body.appendChild(video);
            video.style.position = "fixed";
            video.style.top = 0;
            video.style.left = 0;
            video.style.width = "100%";
            video.style.height = "100%";
            video.style.zIndex = 9999;

            const scanLoop = setInterval(async () => {
                try {
                    const barcodes = await detector.detect(video);
                    if (barcodes.length > 0) {
                        const code = barcodes[0].rawValue;
                        barcodeInput.value = code;

                        clearInterval(scanLoop);
                        stream.getTracks().forEach(t => t.stop());
                        video.remove();

                        alert("Scan สำเร็จ: " + code);
                    }
                } catch (e) {
                    console.log("detecting…");
                }
            }, 200);

        } catch (error) {
            console.error(error);
            alert("เปิดกล้องไม่ได้ / ตรวจจับไม่ได้");
        }
    });

    // --- อ่านบาร์โค้ดจากรูป ---
    uploadBtn.addEventListener("click", () => uploadInput.click());

    uploadInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (!("BarcodeDetector" in window)) {
            alert("เครื่องนี้ไม่รองรับ Barcode Detector API");
            return;
        }

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        await img.decode();

        const detector = new BarcodeDet
