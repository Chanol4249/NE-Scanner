<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NE Scanner</title>

<!-- ZXing Barcode Reader -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<!-- LIFF -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
    body { font-family: sans-serif; padding: 20px; }
    input, button {
        width: 100%;
        padding: 14px;
        margin-top: 10px;
        font-size: 18px;
        border-radius: 10px;
        border: 1px solid #ccc;
    }
    #videoPreview {
        width: 100%;
        margin-top: 20px;
        display: none;
        border: 2px solid #ccc;
        border-radius: 10px;
    }
</style>
</head>

<body>

<h2>üì¶ NE Scanner</h2>

<label>Barcode</label>
<input id="barcode" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">

<label>Quantity</label>
<input id="qty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">

<label>EXP</label>
<input id="exp" placeholder="12.12.26">

<button id="scanBtn">üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</button>
<button id="uploadBtn">üñº ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</button>
<button id="sendBtn" style="background:#4CAF50; color:white;">üì® ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ LINE OA</button>

<input type="file" id="uploadInput" accept="image/*" style="display:none">

<video id="videoPreview" autoplay playsinline></video>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    /* ------------------------------------
       INIT LIFF
    ------------------------------------ */
    await liff.init({ liffId: "2008669852-4EpVRZNo" });

    const barcodeInput = document.getElementById("barcode");
    const qtyInput = document.getElementById("qty");
    const expInput = document.getElementById("exp");

    const video = document.getElementById("videoPreview");
    const scanBtn = document.getElementById("scanBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadInput = document.getElementById("uploadInput");
    const sendBtn = document.getElementById("sendBtn");

    const codeReader = new ZXing.BrowserMultiFormatReader();

    /* ------------------------------------
       1) ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
    ------------------------------------ */
    scanBtn.addEventListener("click", async () => {
        video.style.display = "block";

        try {
            const result = await codeReader.decodeOnceFromVideoDevice(null, video);
            barcodeInput.value = result.text;
            video.style.display = "none";
            codeReader.reset();
        } catch (err) {
            alert("‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err);
        }
    });

    /* ------------------------------------
       2) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ + ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
    ------------------------------------ */
    uploadBtn.addEventListener("click", () => uploadInput.click());

    uploadInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const imgURL = URL.createObjectURL(file);

        try {
            const result = await codeReader.decodeFromImageUrl(imgURL);
            barcodeInput.value = result.text;
        } catch (err) {
            alert("‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
        }
    });

    /* ------------------------------------
       3) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ LINE OA
    ------------------------------------ */
    sendBtn.addEventListener("click", async () => {
        const barcode = barcodeInput.value.trim();
        const qty = qtyInput.value.trim();
        const exp = expInput.value.trim();

        if (!barcode || !qty || !exp) {
            alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
            return;
        }

        const message =
            `barcode: ${barcode}\n` +
            `qty: ${qty}\n` +
            `exp: ${exp}`;

        try {
            await liff.sendMessages([
                { type: "text", text: message }
            ]);

            alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üéâ");

            barcodeInput.value = "";
            qtyInput.value = "";
            expInput.value = "";

        } catch (err) {
            alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err);
        }
    });

});
</script>

</body>
</html>
